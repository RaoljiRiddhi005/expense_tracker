{% extends "base.html" %}

{% block content %}

<h2 class="mb-4">Welcome, {{ username }}</h2>

<!-- Filter Section -->
<div class="card p-3 mb-4">
  <div class="row g-3">
    <div class="col-md-3">
      <label class="form-label">Filter Type</label>
      <select id="filterType" class="form-select">
        <option value="month" {% if filter_type=="month" %}selected{% endif %}>Month</option>
        <option value="year" {% if filter_type=="year" %}selected{% endif %}>Year</option>
        <option value="week" {% if filter_type=="week" %}selected{% endif %}>Week</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Year</label>
      <select id="filterYear" class="form-select">
        {% for y in range(2023, 2031) %}
          <option value="{{ y }}" {% if year==y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3" id="monthSelect" {% if filter_type=="year" %}style="display:none"{% endif %}>
      <label class="form-label">Month</label>
      <select id="filterMonth" class="form-select">
        {% set months = [
          (1, "January"), (2, "February"), (3, "March"), (4, "April"),
          (5, "May"), (6, "June"), (7, "July"), (8, "August"),
          (9, "September"), (10, "October"), (11, "November"), (12, "December")
        ] %}
        {% for num, name in months %}
          <option value="{{ num }}" {% if month and month|int==num %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3" id="weekSelect" {% if filter_type!="week" %}style="display:none"{% endif %}>
      <label class="form-label">Week</label>
      <select id="filterWeek" class="form-select">
        {% for w in range(1,6) %}
          <option value="{{ w }}" {% if week and week|int==w %}selected{% endif %}>Week {{ w }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
</div>

<!-- Summary -->
<div class="row text-center mb-4">
  <div class="col-md-4">
    <div class="card bg-success text-white p-3 rounded-3">
      <h5>Total Income</h5>
      <h3>₹ {{ total_income }}</h3>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card bg-danger text-white p-3 rounded-3">
      <h5>Total Expense</h5>
      <h3>₹ {{ total_expense }}</h3>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card bg-primary text-white p-3 rounded-3">
      <h5>Current Balance</h5>
      <h3>₹ {{ current_balance }}</h3>
    </div>
  </div>
</div>

<!-- Transactions Table -->
<div class="card p-3">
  <h5>Transactions</h5>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Type</th>
        <th>Amount</th>
        <th>Category/Source</th>
        <th>Description/Notes</th>
        <th>Payment/Received Via</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody>
      {% for t in transactions %}
      <tr>
        <td>{{ t.type }}</td>
        <td>{{ t.amount }}</td>
        <td>{{ t.category if t.type=='Expense' else t.source }}</td>
        <td>{{ t.description if t.type=='Expense' else t.notes }}</td>
        <td>{{ t.payment_mode if t.type=='Expense' else t.received_via }}</td>
        <td>{{ t.date }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
const filterType = document.getElementById("filterType");
const filterYear = document.getElementById("filterYear");
const filterMonth = document.getElementById("filterMonth");
const filterWeek = document.getElementById("filterWeek");

function applyFilters() {
  const type = filterType.value;
  const year = filterYear.value;
  let url = `?filterType=${type}&year=${year}`;

  if (type === "month") {
    url += `&month=${filterMonth.value}`;
  }
  if (type === "week") {
    url += `&month=${filterMonth.value}&week=${filterWeek.value}`;
  }

  window.location.href = url;
}

// Toggle visibility of month/week dropdowns
filterType.addEventListener("change", () => {
  document.getElementById("monthSelect").style.display = (filterType.value === "year") ? "none" : "block";
  document.getElementById("weekSelect").style.display = (filterType.value === "week") ? "block" : "none";
  applyFilters();
});

filterYear.addEventListener("change", applyFilters);
filterMonth.addEventListener("change", applyFilters);
filterWeek.addEventListener("change", applyFilters);
</script>

{% endblock %}
